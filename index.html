<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registre Setmanal - Àlbum A5</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 500px; margin: 40px auto; padding: 20px; background-color: #f4f7f6; text-align: center; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50; }
        input[type="range"] { width: 100%; cursor: pointer; }
        .range-value { text-align: center; font-size: 2.5em; font-weight: bold; color: #3498db; }
        textarea { width: 100%; height: 100px; padding: 12px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; resize: none; }
        input[type="file"] { width: 100%; padding: 10px 0; }
        button { width: 100%; padding: 15px; background-color: #27ae60; color: white; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background-color: #219150; }
        #loading { display: none; color: #7f8c8d; font-style: italic; margin-bottom: 15px; }
        #result-container { display: none; }
    </style>
</head>
<body>

    <div id="survey-content">
        <h1>Registre Setmanal</h1>
        
        <div class="form-group">
            <label>Com ha anat la setmana? (0-10)</label>
            <input type="range" id="score" min="0" max="10" value="5" oninput="document.getElementById('val').innerText = this.value">
            <div class="range-value" id="val">5</div>
        </div>

        <div class="form-group">
            <label>Comentari per a l'àlbum:</label>
            <textarea id="comment" placeholder="Escriu la frase que anirà sota la foto..."></textarea>
        </div>

        <div class="form-group">
            <label>Foto de la setmana (ajustada a 85mm d'alt):</label>
            <input type="file" id="image-input" accept="image/*">
        </div>

        <div id="loading">Enviant a la bústia de l'àlbum...</div>
        <button id="btn-enviar" onclick="processarEnviament()">Guardar Setmana</button>
    </div>

    <div id="result-container">
        <h2 id="final-greeting"></h2>
        <div id="gif-box"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // Reemplaza con tus claves reales
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_PROYECTO.firebaseapp.com",
            projectId: "TU_PROYECTO_ID",
            storageBucket: "TU_PROYECTO.appspot.com",
            messagingSenderId: "TU_SENDER_ID",
            appId: "TU_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        window.processarEnviament = async function() {
            const nom = prompt("El teu nom:");
            if (!nom) return;
            const cognom = prompt("El teu cognom:");
            if (!cognom) return;

            const nota = parseInt(document.getElementById('score').value);
            const comentari = document.getElementById('comment').value;
            const fitxer = document.getElementById('image-input').files[0];

            document.getElementById('btn-enviar').disabled = true;
            document.getElementById('loading').style.display = 'block';

            try {
                let imatgeData = "";
                if (fitxer) imatgeData = await toBase64(fitxer);

                // Cálculo de la semana actual del año
                const ara = new Date();
                const iniciAny = new Date(ara.getFullYear(), 0, 1);
                const dies = Math.floor((ara - iniciAny) / (24 * 60 * 60 * 1000));
                const numSetmana = Math.ceil((dies + iniciAny.getDay() + 1) / 7);

                await addDoc(collection(db, "registre_album_A5"), {
                    nom_complet: `${nom} ${cognom}`,
                    nota: nota,
                    comentari: comentari,
                    imatge_base64: imatgeData,
                    setmana_any: numSetmana,
                    data_text: ara.toLocaleDateString("ca-ES", { day: 'numeric', month: 'long' }),
                    timestamp: serverTimestamp()
                });

                document.getElementById('survey-content').style.display = 'none';
                document.getElementById('final-greeting').innerText = `Fet! Setmana ${numSetmana} guardada.`;
                document.getElementById('result-container').style.display = 'block';
                showGif(nota);

            } catch (e) {
                console.error(e);
                alert("Error. La foto podria ser massa pesada.");
                document.getElementById('btn-enviar').disabled = false;
                document.getElementById('loading').style.display = 'none';
            }
        };

        function showGif(nota) {
            let gifId = nota <= 3 ? "16778760554072111618" : nota <= 6 ? "13031104854113737447" : nota <= 8 ? "15272861" : "5549795156449910681";
            document.getElementById('gif-box').innerHTML = `<div class="tenor-gif-embed" data-postid="${gifId}" data-share-method="host" data-aspect-ratio="1" data-width="100%"></div>`;
            const script = document.createElement('script'); script.src = "https://tenor.com/embed.js"; document.body.appendChild(script);
        }
    </script>
</body>
</html>
