<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registre Setmanal - Àlbum A5</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 500px; margin: 40px auto; padding: 20px; background-color: #f4f7f6; text-align: center; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50; }
        .range-value { text-align: center; font-size: 2.5em; font-weight: bold; color: #3498db; }
        textarea { width: 100%; height: 80px; padding: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; resize: none; }
        
        /* Contenidor del retall */
        #cropper-wrapper { display: none; margin: 20px 0; background: #eee; border-radius: 8px; overflow: hidden; max-height: 400px; }
        #image-to-crop { max-width: 100%; display: block; }
        
        button { width: 100%; padding: 15px; background-color: #27ae60; color: white; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; }
        
        #result-container { display: none; }
        #loading { display: none; color: #7f8c8d; font-style: italic; margin: 15px 0; font-weight: bold; }
    </style>
</head>
<body>

    <div id="survey-content">
        <h1>Registre Setmanal</h1>
        
        <div class="form-group">
            <label>Com ha anat la setmana? (0-10):</label>
            <input type="range" id="score" min="0" max="10" value="5" oninput="document.getElementById('val').innerText = this.value" style="width:100%">
            <div class="range-value" id="val">5</div>
        </div>

        <div class="form-group">
            <label>El meu comentari:</label>
            <textarea id="comment" placeholder="Escriu la frase per a l'àlbum..."></textarea>
        </div>

        <div class="form-group">
            <label>Tria i retalla la foto:</label>
            <input type="file" id="image-input" accept="image/*">
        </div>

        <div id="cropper-wrapper">
            <img id="image-to-crop">
        </div>

        <div id="loading">Enviant dades a la base de dades...</div>
        <button id="btn-enviar" onclick="processarEnviament()">Guardar Setmana</button>
    </div>

    <div id="result-container">
        <h2 id="final-greeting"></h2>
        <div id="gif-box"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // CONFIGURACIÓ FIREBASE - RECORDA POSAR LES TEVES DADES REALS AQUÍ
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_PROYECTO.firebaseapp.com",
            projectId: "TU_PROYECTO_ID",
            storageBucket: "TU_PROYECTO.appspot.com",
            messagingSenderId: "TU_SENDER_ID",
            appId: "TU_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let cropper;
        const imageInput = document.getElementById('image-input');
        const imageToCrop = document.getElementById('image-to-crop');
        const cropperWrapper = document.getElementById('cropper-wrapper');

        // Escolta quan tries una imatge
        imageInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imageToCrop.src = event.target.result;
                    cropperWrapper.style.display = 'block';
                    if (cropper) cropper.destroy();
                    
                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: 16 / 9,
                        viewMode: 1,
                        autoCropArea: 1
                    });
                };
                reader.readAsDataURL(files[0]);
            }
        });

        window.processarEnviament = async function() {
            const nom = prompt("El teu nom:");
            if (!nom) return;
            const cognom = prompt("El teu cognom:");
            if (!cognom) return;

            const loader = document.getElementById('loading');
            const btn = document.getElementById('btn-enviar');
            
            // Bloquegem el botó i mostrem el text de càrrega
            btn.disabled = true;
            loader.style.display = 'block';

            try {
                let imatgeFinal = "";
                
                // NOMÉS retalla si hi ha una foto seleccionada
                if (cropper && imageInput.files.length > 0) {
                    imatgeFinal = cropper.getCroppedCanvas({ 
                        width: 800,
                        imageSmoothingQuality: 'medium'
                    }).toDataURL('image/jpeg', 0.5); // Qualitat mitjana per estalviar espai
                }

                const ara = new Date();
                const iniciAny = new Date(ara.getFullYear(), 0, 1);
                const numSetmana = Math.ceil((Math.floor((ara - iniciAny) / 86400000) + iniciAny.getDay() + 1) / 7);
                const notaActual = parseInt(document.getElementById('score').value);

                // ENVIAMENT A FIREBASE
                await addDoc(collection(db, "registre_album_A5"), {
                    usuari: `${nom} ${cognom}`,
                    nota: notaActual,
                    comentari: document.getElementById('comment').value || "",
                    imatge_base64: imatgeFinal,
                    setmana: numSetmana,
                    data_text: ara.toLocaleDateString("ca-ES", { day: 'numeric', month: 'long' }),
                    timestamp: serverTimestamp()
                });

                // Si tot va bé, netegem i mostrem el GIF
                loader.style.display = 'none';
                document.getElementById('survey-content').style.display = 'none';
                document.getElementById('final-greeting').innerText = `Setmana ${numSetmana} guardada!`;
                document.getElementById('result-container').style.display = 'block';
                showGif(notaActual);

            } catch (e) {
                console.error("Error detallat:", e);
                alert("Error d'enviament. Revisa les Regles de Firebase o la teva connexió.");
                btn.disabled = false;
                loader.style.display = 'none';
            }
        };

        function showGif(nota) {
            let gifId = nota <= 3 ? "16778760554072111618" : nota <= 6 ? "13031104854113737447" : nota <= 8 ? "15272861" : "5549795156449910681";
            document.getElementById('gif-box').innerHTML = `<div class="tenor-gif-embed" data-postid="${gifId}" data-width="100%"></div>`;
            const script = document.createElement('script'); 
            script.src = "https://tenor.com/embed.js"; 
            document.body.appendChild(script);
        }
    </script>
</body>
</html>

