<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registre Setmanal - Àlbum A5</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 500px; margin: 40px auto; padding: 20px; background-color: #f4f7f6; text-align: center; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 10px; font-weight: bold; color: #2c3e50; }
        .range-value { text-align: center; font-size: 2em; font-weight: bold; color: #3498db; }
        textarea { width: 100%; height: 100px; padding: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; resize: none; }
        
        /* Contenidor del retall */
        #cropper-wrapper { display: none; margin: 20px 0; background: #eee; border-radius: 8px; overflow: hidden; max-height: 400px; }
        #image-to-crop { max-width: 100%; display: block; }
        
        button { width: 100%; padding: 15px; background-color: #27ae60; color: white; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; font-weight: bold; }
        button:disabled { background-color: #95a5a6; }
        #loading { display: none; color: #7f8c8d; font-style: italic; margin-bottom: 10px; }
        #result-container { display: none; }
    </style>
</head>
<body>

    <div id="survey-content">
        <h1>Registre Setmanal</h1>
        
        <div class="form-group">
            <label>Com ha anat la setmana? (0-10):</label>
            <input type="range" id="score" min="0" max="10" value="5" oninput="document.getElementById('val').innerText = this.value" style="width:100%">
            <div class="range-value" id="val">5</div>
        </div>

        <div class="form-group">
            <label>El meu comentari per a l'àlbum:</label>
            <textarea id="comment" placeholder="Aquest text apareixerà sota la foto..."></textarea>
        </div>

        <div class="form-group">
            <label>Tria i retalla la teva foto:</label>
            <input type="file" id="image-input" accept="image/*">
        </div>

        <div id="cropper-wrapper">
            <img id="image-to-crop">
        </div>

        <div id="loading">Processant i enviant a la base de dades...</div>
        <button id="btn-enviar" onclick="processarEnviament()">Guardar Setmana</button>
    </div>

    <div id="result-container">
        <h2 id="final-greeting"></h2>
        <div id="gif-box"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // CONFIGURACIÓ FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyChNvtLiyY0pd5jUNtZzZH_GK72E97jteo",
          authDomain: "registro-semanal.firebaseapp.com",
          projectId: "registro-semanal",
          storageBucket: "registro-semanal.firebasestorage.app",
          messagingSenderId: "452354811680",
          appId: "1:452354811680:web:da02eed1b1d1aa8d40d945",
          measurementId: "G-9JG5M7CGT9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let cropper;
        const imageInput = document.getElementById('image-input');
        const imageToCrop = document.getElementById('image-to-crop');
        const cropperWrapper = document.getElementById('cropper-wrapper');

        // Escolta quan es tria una foto per activar el Cropper
        imageInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imageToCrop.src = event.target.result;
                    cropperWrapper.style.display = 'block';
                    if (cropper) cropper.destroy();
                    
                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: 16 / 9, // Ideal per al format de l'àlbum
                        viewMode: 1,
                        autoCropArea: 1
                    });
                };
                reader.readAsDataURL(files[0]);
            }
        });

        window.processarEnviament = async function() {
            const nom = prompt("El teu nom:");
            if (!nom) return;
            const cognom = prompt("El teu cognom:");
            if (!cognom) return;

            // Creem nom de col·lecció dinàmic (ex: registre_jordi_garcia)
            const usuarioColeccion = `registre_${nom.trim().toLowerCase().replace(/\s+/g, '_')}_${cognom.trim().toLowerCase().replace(/\s+/g, '_')}`;

            const btn = document.getElementById('btn-enviar');
            const loader = document.getElementById('loading');

            btn.disabled = true;
            loader.style.display = 'block';

            try {
                let imatgeFinal = "";
                
                if (cropper) {
                    // Generem el retall optimitzat a 800px d'ample
                    imatgeFinal = cropper.getCroppedCanvas({ width: 800 }).toDataURL('image/jpeg', 0.8);
                    
                    // Validació simple de pes (1MB aprox)
                    if (imatgeFinal.length > 1400000) { 
                        alert("La imatge és massa gran després de retallar. Prova un retall més petit.");
                        btn.disabled = false;
                        loader.style.display = 'none';
                        return;
                    }
                }

                const nota = parseInt(document.getElementById('score').value);
                const comentari = document.getElementById('comment').value;

                await addDoc(collection(db, usuarioColeccion), {
                    usuari: `${nom} ${cognom}`,
                    nota: nota,
                    comentari: comentari,
                    imatge_base64: imatgeFinal,
                    fecha_formatada: new Date().toLocaleDateString("ca-ES", { day: 'numeric', month: 'long', year: 'numeric' }),
                    timestamp: serverTimestamp()
                });

                // Èxit
                loader.style.display = 'none';
                document.getElementById('survey-content').style.display = 'none';
                document.getElementById('final-greeting').innerText = `Setmana registrada, ${nom}!`;
                document.getElementById('result-container').style.display = 'block';
                showGif(nota);

            } catch (e) {
                console.error("Error:", e);
                alert("Error en guardar. Revisa la mida de la foto o la connexió.");
                btn.disabled = false;
                loader.style.display = 'none';
            }
        };

        function showGif(nota) {
            let gifId = nota <= 3 ? "16778760554072111618" : nota <= 6 ? "13031104854113737447" : nota <= 8 ? "15272861" : "5549795156449910681";
            document.getElementById('gif-box').innerHTML = `<div class="tenor-gif-embed" data-postid="${gifId}" data-width="100%"></div>`;
            const script = document.createElement('script'); 
            script.src = "https://tenor.com/embed.js"; 
            document.body.appendChild(script);
        }
    </script>
</body>
</html>
    </script>
</body>
</html>



